<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>SF - Neighborhood Survey Builder</title>
    
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js' type="text/javascript"></script>
    <script src='wax/ext/leaflet.js' type='text/javascript'></script>
    <script src='wax/dist/wax.leaf.js' type='text/javascript'></script>
    <style type="text/css" media="screen">
      @import url(css/reset.css);
      @import url(css/mobile.css);      
    </style>
    <link href='wax/ext/leaflet.css' rel='stylesheet' type='text/css' />
    
    <script type="text/javascript" charset="utf-8">
      
    
      // We want to share the map around. 
      var map;
      
      // Update the hidden parcel_id field to matcht the parcel the user
      // has selected
      function setFormParcel(id) {
        // Get the block+lot from the interaction data. 
        // Later on, this will need to be a variable / paramaterized; or 
        // standardized per base layer dataset.
        var blocklot = id.data.BLKLOT;
        var human_readable_location = id.data.FROM_ST;
        if (id.data.FROM_ST != id.data.TO_ST) {
            human_readable_location += "-" + id.data.TO_ST;
        };
        human_readable_location += " " + id.data.STREET + " " + id.data.ST_TYPE;
        
        $('#parcel_id').val(blocklot);
        $('h2 .parcel_id').text(human_readable_location);
        
        console.log(id.data);
      }
      
      wax.tilejson('http://a.tiles.mapbox.com/v3/matth.map-g0f7yd6r.jsonp',
        function(tilejson) {
          map = new L.Map('map-div');
          map.addLayer(new wax.leaf.connector(tilejson));
          wax.leaf.interaction()
            .map(map)
            .tilejson(tilejson)
            .on('on', function(o) {
                // console.log(o.e.type);
                if (o.e.type == 'mouseup') { // was mousemove
                    console.log(o.formatter({format:'full'}, o.data));
                    setFormParcel(o);
                   // // create a marker in the given location and add it to the map
                   // var marker = new L.Marker(map.mouseEventToLatLng(o.e));
                   // map.addLayer(marker);
                   //
                   // // attach a given HTML content to the marker and immediately open it
                   // marker.bindPopup(o.formatter({ format: 'teaser' }, o.data)).openPopup();
                }
            });
          
           
      		map.on('locationfound', onLocationFound);
      		map.on('locationerror', onLocationError);

      		map.locateAndSetView(18);
      		
      		function onLocationFound(e) {
      			var radius = e.accuracy / 2;

      			var marker = new L.Marker(e.latlng);
      			map.addLayer(marker);
      		//	marker.bindPopup("You are within " + radius + " meters of this point").openPopup();

      			var circle = new L.Circle(e.latlng, radius);
      			map.addLayer(circle);
      		}

      		function onLocationError(e) {
      			alert(e.message);
      		}
      });
      
      $(document).ready(function(){
          /* attach a submit handler to the form */
          $("#parcelform").submit(function(event) {
            /* stop form from submitting normally */
            event.preventDefault(); 

            /* get some values from elements on the page: */
            var $form = $( this ),
                parcel_id = $form.find( 'input[name="parcel_id"]' ).val(),
                points = $form.find( 'input[name="points"]' ).val(),
                url = $form.attr( 'action' );

            /* Send the data using post and put the results in a div */
            $.post( url, 
                { responses: [{ parcels: [{
                    parcel_id: parcel_id, 
                    responses: {
                        points: points,
                    }
                }]}]},
                function( data ) {
                  var content = $( data ).find( '#content' );
                  $( "#results" ).empty().append( content );
            });
    
        });      
    });
      
    </script>
</head>

<body>
  <div id="container">

    <div id="head">
      <h1>Survey App</h1>
    </div>

    <div id='map-div' style="height:250px;"></div>
    <div id="form">
      <h2>
          <span class="background">Filling out data for</span>
          <span class="parcel_id">&nbsp;</span>
      </h2>
      
      <form action="http://127.0.0.1:3000/surveys/1/responses" method="post" accept-charset="utf-8" id="parcelform">
        <input type="hidden" name="parcel_id" value="" id="parcel_id">
        <input type="range" name="points" min="1" max="10" />
        <input type="submit" value="Send it in &rarr;">
      </form>
    </div>
  </div>
  
  <script type="text/template" id="item-template">
    <div class="result">
        <input class="check" type="checkbox" <%= done ? 'checked="checked"' : '' %> />
        <p><%= content %></p>
    </div>
  </script>
  
</body>
</html>